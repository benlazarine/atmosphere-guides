<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="Content-Style-Type" content="text/css" />
        <meta name="generator" content="pandoc" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
                    <title>allocation</title>
        <style type="text/css">code{white-space: pre;}</style>
                          <link rel="stylesheet" href="./themes/cyverse/templates/main.css" />
                    <link rel="icon" href="themes/cyverse/media/favicon.ico" type="image/x-icon">
        <link rel="stylesheet" href="themes/cyverse/media/css/normalize.min.css">
        <link rel="stylesheet" href="themes/cyverse/media/css/main.css">
        <script src="themes/cyverse/media/js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
          </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

                <div class="header-container">
            <header class="wrapper clearfix">
                <div class="logo"><img src="themes/cyverse/media/cyverse_logo.png" alt="Staff Guide"></div>
                <h1 class="title"></h1>
            </header>
        </div>
        
        <div class="main-container">
            <div class="main wrapper clearfix">
              <!-- TABLE OF CONTENTS -->
                                  <aside>
                      <h3> TABLE OF CONTENTS </h3>
                      <ul>
                      <li><a href="#navigate-to-the-request-form">Navigate to the request form</a></li>
                      <li><a href="#requesting-more-resources">Requesting more resources</a></li>
                      <li><a href="#calculating-desired-au">Calculating desired AU <a name="calculate-au">🔗</a></a></li>
                      <li><a href="#what-is-a-boot-script-and-why-would-you-use-it">What is a Boot Script and why would you use it</a></li>
                      <li><a href="#variables-that-are-included-in-your-boot-script">Variables that are included in your boot script</a></li>
                      <li><a href="#examples-of-a-full-text-boot-script">Examples of a ‘Full Text’ boot script</a></li>
                      <li><a href="#examples-of-a-url-boot-script">Examples of a ‘URL’ boot script</a></li>
                      <li><a href="#using-web-shell-and-desktop-on-atmosphere">Using Web Shell and Desktop on Atmosphere</a><ul>
                      <li><a href="#general">General</a></li>
                      <li><a href="#web-shell">Web Shell</a></li>
                      <li><a href="#web-desktop">Web Desktop</a></li>
                      <li><a href="#copypaste">Copy/Paste</a></li>
                      <li><a href="#changing-resolution-of-web-desktop">Changing Resolution of Web Desktop</a></li>
                      <li><a href="#persisting-session-in-web-shell">Persisting Session in Web Shell</a><ul>
                      <li><a href="#tmuxscreen-crash-course"><code>tmux</code>/<code>screen</code> Crash Course</a></li>
                      </ul></li>
                      <li><a href="#possible-errors">Possible Errors</a><ul>
                      <li><a href="#connection-error---closed-the-connection">Connection Error - closed the connection</a></li>
                      <li><a href="#connection-error---do-not-have-permission">Connection Error - do not have permission</a></li>
                      <li><a href="#connection-error---failed-to-login">Connection Error - failed to login</a></li>
                      </ul></li>
                      </ul></li>
                      <li><a href="#about-requesting-an-image">About requesting an image</a></li>
                      <li><a href="#navigate-to-the-request-form-1">Navigate to the request form</a></li>
                      <li><a href="#submitting-an-imaging-request">Submitting an imaging request</a></li>
                      <li><a href="#viewing-pending-image-requests">Viewing pending image requests</a></li>
                      <li><a href="#logging-in">Logging in</a></li>
                      </ul>
                  </aside>
                              <!-- MAIN CONTENT -->
              <article>
              <p>This will take you through the process of requesting additional resources.</p>
              <h1 id="navigate-to-the-request-form">Navigate to the request form</h1>
              <p><img src="./media/navigate_to_resource_request_form.gif" /></p>
              <h1 id="requesting-more-resources">Requesting more resources</h1>
              <p>There are two forms of resources: <strong>Allocation</strong> and <strong>Quota</strong>.</p>
              <p><strong>Allocation</strong> is a monthly allotment of time that we allow your virtual machines to run. One of our allocation units (AU) is an hour per cpu of your machine. A 1 cpu machine will consume 1AU for every hour it is active. A 16 cpu machine will consume 16AU per hour. Keep in mind that larger machines need to be suspended often to conserve your AU budget. See <a href="#calculate-au">Calculating desired AU</a>. Allocation is reset every month (it does not carry over).</p>
              <p><strong>Quota</strong> are constraints on resources that don’t change on a monthly basis.</p>
              <ul>
              <li>maximum total cpus</li>
              <li>maximum total volume storage (GB)</li>
              <li>maximum total memory (GB)</li>
              <li>maximum # of volumes</li>
              <li>maximum # of suspended instances</li>
              </ul>
              <p>You can request an increase of Allocation and Quota to the discretion of the support staff. Motivate why the additonal resources are needed in the form above.</p>
              <p>After you submit the form, support will get in touch with you about the status of your request.</p>
              <h1 id="calculating-desired-au">Calculating desired AU <a name="calculate-au">🔗</a></h1>
              <p><img src="./media/au-calculator.gif" /></p>
              <h1 id="what-is-a-boot-script-and-why-would-you-use-it">What is a Boot Script and why would you use it</h1>
              <p>Boot scripts are a way to dynamically modify the environment of your VM at run time.</p>
              <p>Boot scripts can be created for a specific instance Boot scripts can also be created to execute on a new machine (via Machine Request) for all users who launch that VM.</p>
              <p>Boot scripts are executed by the Atmosphere system as the <em>final</em> step of the deployment process.</p>
              <p>These scripts can be used to: - execute a daemon/background processes - change permissions of a directory to match the active running user, rather than your own account.</p>
              <p>These scripts should <em>NOT</em> be used to: - Install new dependencies (Instead, install the software you want and create a Machine Request)</p>
              <p>NOTE: A failure of a boot script may cause your VM to behave in an unexpected way, but time will still be counted against you. Make sure that you test your boot scripts multiple times before distributing it with your VM.</p>
              <h1 id="variables-that-are-included-in-your-boot-script">Variables that are included in your boot script</h1>
              <ul>
              <li>ATMO_USER: This is the username of the account that is running your Image/Instance.</li>
              </ul>
              <h1 id="examples-of-a-full-text-boot-script">Examples of a ‘Full Text’ boot script</h1>
              <p>A Full text boot script should include a shebang line to tell the bash console what program to use. The script will be executed directly.</p>
              <p>Using the templated variables above can be very helpful for creating dynamic boot scripts.</p>
              <pre><code>#!/bin/bash -x
              
              # Permissions Granting Script - v1.0
              #
              # This is a basic &#39;permissions granting&#39; script to be used as a template
              # for image creators, to ensure that their UID is not left on directories
              # critical to the success of their image.
              
              main ()
              {
                  #
                  # This is the main function -- These lines will be executed each run
                  #
              
                  inject_atmo_vars
                  set_directory
              }
              
              inject_atmo_vars ()
              {
                  #
                  #
                  #NOTE: For now, only $ATMO_USER will be provided to script templates (In addition to the standard &#39;env&#39;)
                  #
                  #
              
                  # Source the .bashrc -- this contains $ATMO_USER
                  PS1=&#39;HACK to avoid early-exit in .bashrc&#39;
                  . ~/.bashrc
                  if [ -z &quot;$ATMO_USER&quot; ]; then
                      echo &#39;Variable $ATMO_USER is not set in .bashrc! Abort!&#39;
                      exit 1 # 1 - ATMO_USER is not set!
                  fi
                  echo &quot;Found user: $ATMO_USER&quot;
              }
              
              set_directory ()
              {
                  # Set directory (via recursive `chown`)
                  #TODO: Create a &#39;chown&#39; line for each directory that should be re-assigned to the current user:
                  #
                chown -R $ATMO_USER:iplant-everyone &quot;/opt&quot;
                exit 0
              }
              
              # This line will start the execution of the script
              main</code></pre>
              <h1 id="examples-of-a-url-boot-script">Examples of a ‘URL’ boot script</h1>
              <p>A URL boot script should start with http or https. A URL boot script should point to the <em>RAW</em> file The file the boot script points to should follow all rules listed in <em>Examples of a Full Text boot script</em></p>
              <pre><code>https://raw.githubusercontent.com/iPlantCollaborativeOpenSource/atmosphere/master/core/examples/boot_scripts/grant_permissions.sh</code></pre>
              <h1 id="using-web-shell-and-desktop-on-atmosphere">Using Web Shell and Desktop on Atmosphere</h1>
              <p>This guide will help you to understand and use the Web Desktop and Web Shell on CyVerse’s Atmosphere platform. They are both powered by <a href="https://guacamole.apache.org/">Apache Guacamole</a>.</p>
              <p>The official Guacamole user guide can be found <a href="https://guacamole.apache.org/doc/gug/users-guide.html">here</a>, but please note that not all features will be available on Atmosphere.</p>
              <h2 id="general">General</h2>
              <p>Use <code>CTRL + ALT + SHIFT</code> to open a side menu. From here, you can browse system files and</p>
              <h2 id="web-shell">Web Shell</h2>
              <ul>
              <li>Connect using the “Open Web Shell” button on the instance details page of Atmosphere.</li>
              <li>Uses SSH protocol with public key authentication to connect to your instance. The private keys are created and stored by Atmosphere and Guacamole.</li>
              </ul>
              <p><img src="./media/guac_open_shell.gif" /></p>
              <h2 id="web-desktop">Web Desktop</h2>
              <ul>
              <li>Connect using the “Open Web Desktop” button on the instance details page of Atmosphere.</li>
              <li>Uses VNC protocol.</li>
              </ul>
              <p><img src="./media/guac_open_desktop.gif" /></p>
              <h2 id="copypaste">Copy/Paste</h2>
              <p>In order to copy and paste between your local computer and your instance using our Web Desktop and Web Shell, you must use the text box in the side menu. The reason that you cannot directly copy/paste is that most browsers have strict control of clipboard access. If you use Google Chrome, you can install <a href="https://chrome.google.com/webstore/detail/clipboard-permission-mana/ipbhneeanpgkaleihlknhjiaamobkceh">this extension</a> to allow access to your clipboard. A full explanation of this is available on the <a href="https://guacamole.apache.org/faq/#clipboard">Apache Guacamole website</a>.</p>
              <ul>
              <li>On Web Shell: text from your instance will appear in the text box if you highlight it. Paste text into the terminal by right-clicking.</li>
              </ul>
              <p><img src="./media/guac_shell_copypaste.gif" /></p>
              <ul>
              <li>On Web Desktop: use regular copy/paste methods: <code>CTRL+C</code>/<code>CTRL+V</code>, or right-click and find “Copy”/“Paste”. <em>Note that when using a Terminal within the Desktop, copy/paste commands change to <code>CTRL+SHIFT+C</code>/<code>CTRL+SHIFT+V</code></em></li>
              </ul>
              <p><img src="./media/guac_desktop_copypaste.gif" /></p>
              <h2 id="changing-resolution-of-web-desktop">Changing Resolution of Web Desktop</h2>
              <p>Open a terminal and use these commands:</p>
              <pre><code># Show the available resolution options
              xrandr -q
              
              # Change the resolution using the resolution or the corresponding number.
              xrandr -s &lt;choice&gt;
              # Example: xrandr -s 1920x1080
              #       or xrandr -s 6</code></pre>
              <p><img src="./media/guac_change_resolution.gif" /></p>
              <h2 id="persisting-session-in-web-shell">Persisting Session in Web Shell</h2>
              <p>When you close a Web Shell window, your shell session ends and is not preserved. You may wish to make your shell session persistent, so that you can disconnect from it and reconnect later. For this, we recommend using a terminal multiplexer, either <a href="https://en.wikipedia.org/wiki/Tmux"><code>tmux</code></a> or <a href="https://en.wikipedia.org/wiki/GNU_Screen"><code>screen</code></a> on your instance. Both of these may already be installed. Both can be used to keep your shell session active, and connect to it later, even if your browser disconnects.</p>
              <h3 id="tmuxscreen-crash-course"><code>tmux</code>/<code>screen</code> Crash Course</h3>
              <p>Create a new terminal multiplexer session and activate it:</p>
              <pre><code>tmux
              screen</code></pre>
              <p>Now you can do your work inside terminal multiplexer, and your session will be preserved even if you get disconnected.</p>
              <p>You can explicitly “detach” from your terminal multiplexer session by pressing <code>CTRL+B</code> in <code>tmux</code> or <code>CTRL+A</code> in <code>screen</code>, followed by pressing the <code>d</code> key – though this is not necessary when disconnecting Web Shell. You can just close the browser and your terminal multiplexer session will stay active.</p>
              <p>When you re-connect to Web shell, you can re-attach to the first available terminal multiplexer session (i.e. the one that you opened earlier) with:</p>
              <pre><code>tmux a
              screen -x</code></pre>
              <p>This should bring you back to the same shell, exactly where you were earlier! It’s possible to have more than one terminal multiplexer session open, and this may cause confusion. You can list all active terminal multiplexer sessions with:</p>
              <pre><code>tmux ls
              screen -ls</code></pre>
              <p>If you see multiple sessions listed, you can connect to a named session (e.g. session 0) with</p>
              <pre><code>tmux a -t 0
              screen -x 0</code></pre>
              <p>For more information on using <code>tmux</code>, please see <code>tmux</code> documentation (e.g. <code>man tmux</code>) and other articles on the web (e.g. <a href="https://hackernoon.com/a-gentle-introduction-to-tmux-8d784c404340">A Gentle Introduction to <code>tmux</code></a>).</p>
              <p>For more information on using <code>screen</code>, please see <code>screen</code> documentation (e.g. <code>man screen</code>) and other articles on the web (e.g. <a href="https://wiki.archlinux.org/index.php/GNU_Screen">GNU Screen on Arch Wiki</a>).</p>
              <h2 id="possible-errors">Possible Errors</h2>
              <h4 id="connection-error---closed-the-connection">Connection Error - closed the connection</h4>
              <p><img src="./media/guac_connection_error.png" /></p>
              <p>This means that you were successfully authenticated by the Guacamole server, but it was unable to connect to your instance. This could be an issue with the instance, or perhaps with the server. If it continues to happen after a few tries, contact support. The most likely problem is the VNC server closed.</p>
              <p>You can try to fix this yourself with these commands:</p>
              <pre><code># Kill the Guacamole-specific VNC server
              # If you get an error, that means the server is already killed
              vncserver -kill :5
              
              # Restart the VNC server
              vncserver -config ~/.vnc/config.guac :5</code></pre>
              <h4 id="connection-error---do-not-have-permission">Connection Error - do not have permission</h4>
              <p><img src="./media/guac_perm_err.png" /></p>
              <p>This means you are not authenticated for that connection. You have been authenticated by Guacamole but the instance you are trying to connect to is not your own. If you encounter this error, contact support.</p>
              <h4 id="connection-error---failed-to-login">Connection Error - failed to login</h4>
              <p><img src="./media/guac_login_fail.png" /></p>
              <p>This error occurs on SSH connections when the user mistypes the password or there is a key mismatch. If you still cannot connect after about 3 tries, contact support through Intercom so we can fix the SSH keys.</p>
              <p>This will take you through the process of creating an image.</p>
              <h1 id="about-requesting-an-image">About requesting an image</h1>
              <p>An image is a type of template for a virtual machine. You can launch an instance and install the software and files you want to use, then request an image of the instance using the Request Imaging from within Atmosphere, as outlined below. This allows you to retain a complete copy of all of the changes and updates you made to the instance so you can reuse it again later, much like a template.</p>
              <p><strong>WARNING: <span style="color:red;">It is easy to include sensitive data in a public image.</span></strong></p>
              <p>For other security concerns consult this <a href="https://pods.iplantcollaborative.org/wiki/display/atmman/Requesting+an+Image+of+an+Instance">guide</a>.</p>
              <h1 id="navigate-to-the-request-form-1">Navigate to the request form</h1>
              <p><img src="./media/navigate-to-image-request.gif" /></p>
              <h1 id="submitting-an-imaging-request">Submitting an imaging request</h1>
              <p>Each step has accompanying instructions. After your request has been submitted. Support will get in touch with you about the status of your image request. For more comprehensive documentation consult this <a href="https://pods.iplantcollaborative.org/wiki/display/atmman/Requesting+an+Image+of+an+Instance">guide</a>.</p>
              <h1 id="viewing-pending-image-requests">Viewing pending image requests</h1>
              <p>This animation illustrates viewing a recently submitted request.</p>
              <p><img src="./media/submit-image-request-and-view-pending-requests.gif" /></p>
              <p>This will take you through the login process.</p>
              <h1 id="logging-in">Logging in</h1>
              <p>Navigate to the home page, click login.</p>
              <p><img src="./media/login.gif" /></p>
              </article>
            </div> <!-- #main -->
        </div> <!-- #main-container -->

                <div class="footer-container">
            <footer class="wrapper">
                    <footer class="footer"> <!-- Needs to be a `include-after` -->
          		<div class="container">
          		  <div class="region region-footer">
          		    <section id="block-block-25" class="block block-block clearfix">
          		      <p><img alt="Cyverse" src="./media/cyverse_icon_transp2.png" style="width: 25px; height: 24px;">&nbsp;<a href="http://www.cyverse.org/">CyVerse</a> | <a href="http://www.cyverse.org/open-source">Open Source</a> | <img alt="NSF" src="./media/nsf1.gif" style="width: 25px; height: 25px;">&nbsp;</p>
          		    </section>
          		  </div>
          		</div>
        	    </footer>
            </footer>
        </div>
        <!-- Included at the end of body -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="themes/cyverse/media/js/vendor/jquery-1.11.2.min.js"><\/script>')</script>
        
        <script src="themes/cyverse/media/js/main.js"></script>
            </body>
</html>
